import{g as $,T as oe,a as ie,c as re,b as W,Q as K,_ as ce,d as le}from"./AppDescriptionTop-577eab1b.js";import{o as ue,_ as de,a as fe}from"./SelectToken.vue_vue_type_script_setup_true_lang-92f952ef.js";import{k as y,P as m,m as V,n as pe,S as z,q as G,s as me,u as ve,t as _e,v as u,w as I,x as ye,y as J,z as ke,A as be,B as h,C as M,F as O,G as B,H as j,I as ge,J as Te,K as H,M as he,L as we,N as D,O as Se,Q as Ae,R as xe,o as P,U as Re,V as w,W as Ne,j as l,X as E,Y as L,Z as r,$ as i,i as Y,a0 as Ce,a1 as U,a2 as Q,a3 as X,a4 as Ee,a5 as Me,a6 as qe,a7 as Fe,_ as Ie,a8 as Be}from"./index-ce30933d.js";var Pe=Object.defineProperty,We=(t,e,s)=>e in t?Pe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ke=(t,e,s)=>(We(t,typeof e!="symbol"?e+"":e,s),s);const Ve=new y.BeetArgsStruct([["instructionDiscriminator",y.uniformFixedSizeArray(y.u8,8)],["amount",y.u64]],"SplTransferInstructionArgs"),Oe=[67,186,237,99,235,243,166,198];function je(t,e,s=new m("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=Ve.serialize({instructionDiscriminator:Oe,...e}),d=[{pubkey:t.sender,isWritable:!0,isSigner:!0},{pubkey:t.receiver,isWritable:!0,isSigner:!1},{pubkey:t.tokenMint,isWritable:!1,isSigner:!1},{pubkey:t.source,isWritable:!0,isSigner:!1},{pubkey:t.destination,isWritable:!0,isSigner:!1},{pubkey:t.policy,isWritable:!1,isSigner:!1},{pubkey:t.proofRequest,isWritable:!1,isSigner:!1},{pubkey:t.tokenProgram??pe,isWritable:!1,isSigner:!1},{pubkey:t.systemProgram??z.programId,isWritable:!1,isSigner:!1}];if(t.anchorRemainingAccounts!=null)for(const k of t.anchorRemainingAccounts)d.push(k);return new G({programId:s,keys:d,data:o})}const De=new y.BeetArgsStruct([["instructionDiscriminator",y.uniformFixedSizeArray(y.u8,8)],["amount",y.u64]],"TransferInstructionArgs"),Le=[163,52,200,231,140,3,69,186];function Ue(t,e,s=new m("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=De.serialize({instructionDiscriminator:Le,...e}),d=[{pubkey:t.sender,isWritable:!0,isSigner:!0},{pubkey:t.receiver,isWritable:!0,isSigner:!1},{pubkey:t.policy,isWritable:!1,isSigner:!1},{pubkey:t.proofRequest,isWritable:!1,isSigner:!1},{pubkey:t.systemProgram??z.programId,isWritable:!1,isSigner:!1}];if(t.anchorRemainingAccounts!=null)for(const k of t.anchorRemainingAccounts)d.push(k);return new G({programId:s,keys:d,data:o})}const Qe="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",Xe=new m(Qe);class $e{constructor(e){Ke(this,"programId",Xe),this.provider=e}get connection(){return this.provider.connection}async transfer(e,s){const o=this.createTransferTx(e);return this.provider.sendAndConfirm(o,[],s)}createTransferTx(e){const s=Ue({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new V().add(s)}async getTransferFee(e){const s=this.createTransferTx(e);return this.transactionFee(s)}async transferToken(e,s){const o=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(o,[],s)}async createTransferTokenTx(e){const s=new V;try{await $(this.connection,e.destination)}catch(o){(o instanceof oe||o instanceof ie)&&s.add(re(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return s.add(je({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),s}async getTransferTokenFee(e){const s=await this.createTransferTokenTx(e);return this.transactionFee(s)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:s}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(s)}}const ze=me("transfer",()=>{const t=ve(),e=_e(),s=u(()=>e.tokens),o=I(),{state:d,getUserTokens:k}=I(),f=u(()=>o.certificate),R=u(()=>o.requiredPolicy),q=u(()=>o.certificateValid),S=0,g=ye(),{publicKey:v}=J(),{notify:N}=ke(),n=be({address:"",value:void 0,loading:!1,token:void 0,fee:S,valid:!1});h(s,()=>{!n.token&&s.value[0]&&(n.token=s.value[0])},{immediate:!0});function A(){n.value=void 0,n.fee=S}h(()=>n.token,()=>{A(),o.policySpec=n.token?.name??""}),h(()=>g.value?.publicKey,a=>{a||(A(),n.address="")}),h(()=>n.address,async()=>{n.valid=M(n.address)});const _=u(()=>{const a=n.token?.mint??"";return M(a)?new m(a):""}),b=u(()=>M(n.address)?new m(n.address):""),p=O(),c=O(!1);h([_,b,()=>n.valid],async()=>{if(n.token?.mint===B)return c.value=!0;if(_.value&&b.value&&n.valid)try{return p.value=await W(_.value,b.value),await $(t.connection,p.value),c.value=!0}catch{c.value=!1}c.value=!1}),h([()=>n.valid,()=>n.value,p],()=>{n.valid&&Number(n.value)>0?F():n.fee=S});const C=u(()=>new $e(new j(t.connection,g.value??{publicKey:m.default},j.defaultOptions())));async function F(){const a=await ge(g.value?.publicKey,n.address,Number(n.value),t.connection),T=await Te(a,t.connection)+H;return n.fee=c.value?T:T+he}async function x(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",f.value),q.value){let a;n.token?.mint===B?a=await Z():a=await ee(),N({type:"positive",message:"Transaction confirmed",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${a}?cluster=${t.cluster}`,onClick:()=>!1}]}),A(),await k()}else we()}catch(a){console.error("verifyTransfer error: ",a)}finally{n.loading=!1}}async function Z(){if(f.value){const a=new D(Number(n.value)*Se),T=new m(n.address);return await C.value.transfer({amount:a,receiver:T,proofRequest:f.value.pubkey,policy:new m(R.value)})}}async function ee(){if(!v.value||!n.token?.mint)return;const a=d.tokens.find(ae=>ae.mint===n.token?.mint);if(!a||!_.value||!b.value||!g.value||!f.value)return;const T=await W(_.value,v.value),se=new D(Number(n.value)*10**a.decimals);return await C.value.transferToken({destination:p.value,source:T,tokenMint:_.value,amount:se,receiver:b.value,proofRequest:f.value.pubkey,policy:new m(R.value)})}function ne(a){n.value=a}function te(a){n.token=a}return{state:n,setMax:ne,setToken:te,verifyTransfer:x}}),Ge={class:"swap-form"},Je={class:"swap-field"},He={class:"swap-field__info"},Ye={class:"row"},Ze=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),en={class:"col row justify-end swap-field__balance q-pr-sm"},nn={key:0,class:"insufficient-error"},tn=r("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),sn={class:"row justify-between",style:{gap:"10px"}},an={class:"transfer-address"},on=r("div",{class:"col transfer-address__label"}," Address ",-1),rn={class:"swap-info q-mt-md"},cn=r("dt",null,"Transfer fee:",-1),ln={class:"swap-submit"},un=Ae({__name:"TransferCard",setup(t){const{state:e,setMax:s,setToken:o,verifyTransfer:d}=ze(),{state:k,tokenBalance:f}=I(),{handleSearchToken:R,tokens:q}=xe(),S=u(()=>[...q.value].sort((p,c)=>f(c.symbol)-f(p.symbol))),{connected:g}=J(),v=u(()=>e.token?.mint?f(e.token.mint):0),N=u(()=>v.value===0),n=u(()=>Number(e.value)>v.value);async function A(){const p=n.value?"Insufficient funds":"Not valid address";if(!e.valid||n.value)return Me.create({type:"negative",timeout:2e3,message:p});d()}function _(){s(v.value),e.token?.mint===B&&(e.value=v.value-qe-3*Fe-H)}const b=u(()=>Number(e.value)>0&&M(e.address));return(p,c)=>{const C=de,F=fe;return P(),Re(Ne,{class:"swap-card transfer-card"},{default:w(()=>[l(L,{class:"swap-card__header"},{default:w(()=>[E(" Transfer ")]),_:1}),l(L,{class:"swap-card__body"},{default:w(()=>[r("div",Ge,[r("div",Je,[r("div",He,[r("div",Ye,[Ze,r("div",en,[i(n)?(P(),Y("div",nn," Insufficient funds ")):Ce("",!0),E(" Balance: "+U(i(Q)(i(v))),1)]),tn])]),r("div",sn,[l(K,{modelValue:i(e).value,"onUpdate:modelValue":c[0]||(c[0]=x=>i(e).value=x),disable:i(N),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:i(ue)},{append:w(()=>[l(X,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:_},{default:w(()=>[E(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),l(C,{disable:!i(g),options:i(S),onHandleSearchToken:i(R),onSetToken:i(o)},null,8,["disable","options","onHandleSearchToken","onSetToken"])])])]),r("div",an,[on,l(K,{modelValue:i(e).address,"onUpdate:modelValue":c[1]||(c[1]=x=>i(e).address=x),disable:i(N),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",rn,[r("dl",null,[cn,r("dd",null,U(i(Q)(i(e).fee,6)),1)])]),l(F,{class:"q-my-md q-mx-auto"}),r("div",ln,[l(X,{loading:i(e)?.loading,disable:!i(b),rounded:"",ripple:!1,onClick:A},{default:w(()=>[E(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),l(Ee,{showing:i(k)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),dn={},fn={class:"main-block row justify-center"};function pn(t,e){const s=ce,o=un,d=le;return P(),Y(Be,null,[l(s,{class:"q-mt-xl"}),r("div",fn,[l(o)]),l(d,{class:"q-mt-lg"})],64)}const yn=Ie(dn,[["render",pn]]);export{yn as default};
