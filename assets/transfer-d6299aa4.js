import{_ as he,a as we,b as Te}from"./AppDescriptionTop-64cb5314.js";import{o as Se,_ as Ae}from"./PolicyCard.vue_vue_type_script_setup_true_lang-68c02584.js";import{_ as Ee}from"./SelectToken.vue_vue_type_script_setup_true_lang-136e90ea.js";import{P as u,s as oe,u as K,k as Ne,m as l,n as B,q as L,a as ie,S as X,t as G,v as y,w as Q,x as Ie,y as xe,z as Ce,A as p,B as U,C as Re,F as re,G as Fe,H as Me,I as Pe,J as A,K as W,L as $,M as D,N as H,O as We,Q as J,R as qe,U as Oe,V as ce,W as ze,X as Be,Y as Z,Z as Le,$ as Ke,a0 as Ue,a1 as De,o as V,a2 as Ve,a3 as E,a4 as je,j as f,a5 as P,a6 as Y,a7 as c,a8 as r,i as le,a9 as Xe,aa as ee,ab as ne,ac as te,ad as se,ae as Ge,af as Qe,ag as $e,ah as He,_ as Je,ai as Ze}from"./index-5618f963.js";const R=new u("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");new u("TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb");const ue=new u("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");new u("So11111111111111111111111111111111111111112");new u("9pan9bMn5HatX4EJdBwg9VgCa7Uz5HL8N1m5D3NdXejP");class O extends Error{constructor(e){super(e)}}class de extends O{constructor(){super(...arguments),this.name="TokenAccountNotFoundError"}}class Ye extends O{constructor(){super(...arguments),this.name="TokenInvalidAccountError"}}class fe extends O{constructor(){super(...arguments),this.name="TokenInvalidAccountOwnerError"}}class ae extends O{constructor(){super(...arguments),this.name="TokenInvalidAccountSizeError"}}var j;(function(n){n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account"})(j||(j={}));const en=1,nn=oe([K("m"),K("n"),Ne("isInitialized"),l("signer1"),l("signer2"),l("signer3"),l("signer4"),l("signer5"),l("signer6"),l("signer7"),l("signer8"),l("signer9"),l("signer10"),l("signer11")]),tn=nn.span;var q;(function(n){n[n.Uninitialized=0]="Uninitialized",n[n.Initialized=1]="Initialized",n[n.Frozen=2]="Frozen"})(q||(q={}));const pe=oe([l("mint"),l("owner"),B("amount"),L("delegateOption"),l("delegate"),K("state"),L("isNativeOption"),B("isNative"),B("delegatedAmount"),L("closeAuthorityOption"),l("closeAuthority")]),C=pe.span;async function sn(n,e,t,s=R){const i=await n.getAccountInfo(e,t);return an(e,i,s)}function an(n,e,t=R){if(!e)throw new de;if(!e.owner.equals(t))throw new fe;if(e.data.length<C)throw new ae;const s=pe.decode(e.data.slice(0,C));let i=ie.Buffer.alloc(0);if(e.data.length>C){if(e.data.length===tn)throw new ae;if(e.data[C]!=j.Account)throw new Ye;i=e.data.slice(C+en)}return{address:n,mint:s.mint,owner:s.owner,amount:s.amount,delegate:s.delegateOption?s.delegate:null,delegatedAmount:s.delegatedAmount,isInitialized:s.state!==q.Uninitialized,isFrozen:s.state===q.Frozen,isNative:!!s.isNativeOption,rentExemptReserve:s.isNativeOption?s.isNative:null,closeAuthority:s.closeAuthorityOption?s.closeAuthority:null,tlvData:i}}function on(n,e,t,s,i=R,d=ue){return rn(n,e,t,s,ie.Buffer.alloc(0),i,d)}function rn(n,e,t,s,i,d=R,m=ue){const w=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:X.programId,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1}];return new G({keys:w,programId:m,data:i})}var cn=Object.defineProperty,ln=(n,e,t)=>e in n?cn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,un=(n,e,t)=>(ln(n,typeof e!="symbol"?e+"":e,t),t);const dn=new y.BeetArgsStruct([["instructionDiscriminator",y.uniformFixedSizeArray(y.u8,8)],["amount",y.u64]],"SplTransferInstructionArgs"),fn=[67,186,237,99,235,243,166,198];function pn(n,e,t=new u("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[s]=dn.serialize({instructionDiscriminator:fn,...e}),i=[{pubkey:n.sender,isWritable:!0,isSigner:!0},{pubkey:n.receiver,isWritable:!0,isSigner:!1},{pubkey:n.tokenMint,isWritable:!1,isSigner:!1},{pubkey:n.source,isWritable:!0,isSigner:!1},{pubkey:n.destination,isWritable:!0,isSigner:!1},{pubkey:n.policy,isWritable:!1,isSigner:!1},{pubkey:n.proofRequest,isWritable:!1,isSigner:!1},{pubkey:n.tokenProgram??R,isWritable:!1,isSigner:!1},{pubkey:n.systemProgram??X.programId,isWritable:!1,isSigner:!1}];if(n.anchorRemainingAccounts!=null)for(const d of n.anchorRemainingAccounts)i.push(d);return new G({programId:t,keys:i,data:s})}const mn=new y.BeetArgsStruct([["instructionDiscriminator",y.uniformFixedSizeArray(y.u8,8)],["amount",y.u64]],"TransferInstructionArgs"),vn=[163,52,200,231,140,3,69,186];function gn(n,e,t=new u("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[s]=mn.serialize({instructionDiscriminator:vn,...e}),i=[{pubkey:n.sender,isWritable:!0,isSigner:!0},{pubkey:n.receiver,isWritable:!0,isSigner:!1},{pubkey:n.policy,isWritable:!1,isSigner:!1},{pubkey:n.proofRequest,isWritable:!1,isSigner:!1},{pubkey:n.systemProgram??X.programId,isWritable:!1,isSigner:!1}];if(n.anchorRemainingAccounts!=null)for(const d of n.anchorRemainingAccounts)i.push(d);return new G({programId:t,keys:i,data:s})}const _n="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",kn=new u(_n);class bn{constructor(e){un(this,"programId",kn),this.provider=e}get connection(){return this.provider.connection}async transfer(e,t){const s=this.createTransferTx(e);return this.provider.sendAndConfirm(s,[],t)}createTransferTx(e){const t=gn({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new Q().add(t)}async getTransferFee(e){const t=this.createTransferTx(e);return this.transactionFee(t)}async transferToken(e,t){const s=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(s,[],t)}async createTransferTokenTx(e){const t=new Q;try{await sn(this.connection,e.destination)}catch(s){(s instanceof de||s instanceof fe)&&t.add(on(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return t.add(pn({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),t}async getTransferTokenFee(e){const t=await this.createTransferTokenTx(e);return this.transactionFee(t)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:t}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(t)}}const yn=Ie("transfer",()=>{const n=xe(),e=Ce(),t=p(()=>e.tokens),s=U(),{state:i,getUserTokens:d}=U(),m=p(()=>s.certificate),w=p(()=>s.requiredPolicy),z=p(()=>s.certificateValid),N=0,T=Re(),{publicKey:_}=re(),{notify:F}=Fe(),k=Me("token-transfer",""),a=Pe({address:"",value:void 0,loading:!1,token:void 0,fee:N,valid:!1});A(t,()=>{t.value.length&&(console.log("find token ===================== ",t.value.find(o=>o.mint===k.value)),a.token=t.value.find(o=>o.mint===k.value)??t.value[0])},{immediate:!0});function I(){a.value=void 0,a.fee=N}A(()=>a.token,()=>{I(),s.policySpec=a.token?.name??"",console.log("state token ===================== ",a.token),a.token&&(k.value=a.token.mint,console.log("transfer token ===================== ",k.value))}),A(()=>T.value?.publicKey,o=>{o||(I(),a.address="")}),A(()=>a.address,async()=>{a.valid=W(a.address)});const b=p(()=>{const o=a.token?.mint??"";return W(o)?new u(o):""}),g=p(()=>W(a.address)?new u(a.address):""),v=$(),h=$(!1);A([b,g,()=>a.valid],async()=>{if(a.token?.mint===D)return h.value=!0;if(b.value&&g.value&&a.valid)try{return v.value=await H(b.value,g.value),await We(n.connection,v.value),h.value=!0}catch{h.value=!1}h.value=!1}),A([()=>a.valid,()=>a.value,v],()=>{a.valid&&Number(a.value)>0?x():a.fee=N});const M=p(()=>new bn(new J(n.connection,T.value??{publicKey:u.default},J.defaultOptions())));async function x(){const o=await qe(T.value?.publicKey,a.address,Number(a.value),n.connection),S=await Oe(o,n.connection)+ce;return a.fee=h.value?S:S+ze}async function me(){try{if(a.loading=!0,console.log("[debug] on transfer certificate === ",m.value),z.value){let o;a.token?.mint===D?o=await ve():o=await ge(),F({type:"positive",message:"Transaction confirmed",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${o}?cluster=${n.cluster}`,onClick:()=>!1}]}),I(),await d()}else Be()}catch(o){console.error("verifyTransfer error: ",o)}finally{a.loading=!1}}async function ve(){if(m.value){const o=new Z(Number(a.value)*Le),S=new u(a.address);return await M.value.transfer({amount:o,receiver:S,proofRequest:m.value.pubkey,policy:new u(w.value)})}}async function ge(){if(!_.value||!a.token?.mint)return;const o=i.tokens.find(ye=>ye.mint===a.token?.mint);if(!o||!b.value||!g.value||!T.value||!m.value)return;const S=await H(b.value,_.value),be=new Z(Number(a.value)*10**o.decimals);return await M.value.transferToken({destination:v.value,source:S,tokenMint:b.value,amount:be,receiver:g.value,proofRequest:m.value.pubkey,policy:new u(w.value)})}function _e(o){a.value=o}function ke(o){console.log("set token ======== ",o),a.token=o}return{state:a,setMax:_e,setToken:ke,verifyTransfer:me}}),hn={class:"swap-form"},wn={class:"swap-field"},Tn={class:"swap-field__info"},Sn={class:"row"},An=c("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),En={class:"col row justify-end swap-field__balance q-pr-sm"},Nn={key:0,class:"insufficient-error"},In=c("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),xn={class:"row justify-between",style:{gap:"10px"}},Cn={class:"transfer-address"},Rn=c("div",{class:"col transfer-address__label"}," Address ",-1),Fn={class:"swap-info q-mt-md"},Mn=c("dt",null,"Transfer fee:",-1),Pn={class:"swap-submit"},Wn=Ke({__name:"TransferCard",setup(n){const{state:e,setMax:t,setToken:s,verifyTransfer:i}=yn(),{state:d,tokenBalance:m}=U(),{handleSearchToken:w,handleFilterToken:z,tokens:N}=Ue();z(De);const T=p(()=>[...N.value].sort((g,v)=>m(v.symbol)-m(g.symbol)));re();const _=p(()=>e.token?.mint?m(e.token.mint):0),F=p(()=>_.value===0),k=p(()=>Number(e.value)>_.value);async function a(){const g=k.value?"Insufficient funds":"Not valid address";if(!e.valid||k.value)return Qe.create({type:"negative",timeout:2e3,message:g});i()}function I(){t(_.value),e.token?.mint===D&&(e.value=_.value-$e-3*He-ce)}const b=p(()=>Number(e.value)>0&&W(e.address));return(g,v)=>{const h=Ee,M=Ae;return V(),Ve(je,{class:"swap-card transfer-card"},{default:E(()=>[f(Y,{class:"swap-card__header"},{default:E(()=>[P(" Transfer ")]),_:1}),f(Y,{class:"swap-card__body"},{default:E(()=>[c("div",hn,[c("div",wn,[c("div",Tn,[c("div",Sn,[An,c("div",En,[r(k)?(V(),le("div",Nn," Insufficient funds ")):Xe("",!0),P(" Balance: "+ee(r(ne)(r(_))),1)]),In])]),c("div",xn,[f(te,{modelValue:r(e).value,"onUpdate:modelValue":v[0]||(v[0]=x=>r(e).value=x),disable:r(F),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:r(Se)},{append:E(()=>[f(se,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:I},{default:E(()=>[P(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),f(h,{token:r(e).token,options:r(T),onHandleSearchToken:r(w),onSetToken:r(s)},null,8,["token","options","onHandleSearchToken","onSetToken"])])])]),c("div",Cn,[Rn,f(te,{modelValue:r(e).address,"onUpdate:modelValue":v[1]||(v[1]=x=>r(e).address=x),disable:r(F),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),c("div",Fn,[c("dl",null,[Mn,c("dd",null,ee(r(ne)(r(e).fee,6)),1)])]),f(M,{class:"q-my-md q-mx-auto"}),c("div",Pn,[f(se,{loading:r(e)?.loading,disable:!r(b),rounded:"",ripple:!1,onClick:a},{default:E(()=>[P(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),f(Ge,{showing:r(d)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),qn={},On={class:"main-block row justify-center"};function zn(n,e){const t=he,s=Wn,i=we,d=Te;return V(),le(Ze,null,[f(t,{class:"q-mt-lg"}),c("div",On,[f(s)]),f(i,{class:"q-mt-lg"}),f(d,{class:"q-mt-lg"})],64)}const Dn=Je(qn,[["render",zn]]);export{Dn as default};
