import{_ as oe,a as ie,b as re}from"./AppDescriptionTop-33d21100.js";import{o as ce,_ as le}from"./PolicyCard.vue_vue_type_script_setup_true_lang-fe295ab8.js";import{_ as ue}from"./SelectToken.vue_vue_type_script_setup_true_lang-92d8c220.js";import{k,P as v,m as K,S as z,n as G,q as de,u as fe,s as pe,t as u,v as P,w as me,x as J,y as ve,z as _e,A as ke,B as w,C as q,F as O,G as W,H as V,I as ge,J as D,K as ye,L as be,M as H,N as Te,O as he,Q as L,R as we,U as Se,V as Ae,W as xe,o as B,X as Re,Y as S,Z as Ne,j as c,$ as M,a0 as j,a1 as r,a2 as o,i as Y,a3 as Ee,a4 as U,a5 as $,a6 as X,a7 as Q,a8 as Ce,a9 as Me,aa as qe,ab as Fe,_ as Ie,ac as Pe}from"./index-a2ad65bf.js";import{g as We,T as Be,a as Ke,c as Oe,b as Ve}from"./associatedTokenAccount-f411debc.js";var De=Object.defineProperty,Le=(s,e,t)=>e in s?De(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,je=(s,e,t)=>(Le(s,typeof e!="symbol"?e+"":e,t),t);const Ue=new k.BeetArgsStruct([["instructionDiscriminator",k.uniformFixedSizeArray(k.u8,8)],["amount",k.u64]],"SplTransferInstructionArgs"),$e=[67,186,237,99,235,243,166,198];function Xe(s,e,t=new v("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[i]=Ue.serialize({instructionDiscriminator:$e,...e}),d=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.tokenMint,isWritable:!1,isSigner:!1},{pubkey:s.source,isWritable:!0,isSigner:!1},{pubkey:s.destination,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.tokenProgram??Ve,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??z.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const f of s.anchorRemainingAccounts)d.push(f);return new G({programId:t,keys:d,data:i})}const Qe=new k.BeetArgsStruct([["instructionDiscriminator",k.uniformFixedSizeArray(k.u8,8)],["amount",k.u64]],"TransferInstructionArgs"),ze=[163,52,200,231,140,3,69,186];function Ge(s,e,t=new v("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[i]=Qe.serialize({instructionDiscriminator:ze,...e}),d=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??z.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const f of s.anchorRemainingAccounts)d.push(f);return new G({programId:t,keys:d,data:i})}const Je="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",He=new v(Je);class Ye{constructor(e){je(this,"programId",He),this.provider=e}get connection(){return this.provider.connection}async transfer(e,t){const i=this.createTransferTx(e);return this.provider.sendAndConfirm(i,[],t)}createTransferTx(e){const t=Ge({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new K().add(t)}async getTransferFee(e){const t=this.createTransferTx(e);return this.transactionFee(t)}async transferToken(e,t){const i=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(i,[],t)}async createTransferTokenTx(e){const t=new K;try{await We(this.connection,e.destination)}catch(i){(i instanceof Be||i instanceof Ke)&&t.add(Oe(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return t.add(Xe({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),t}async getTransferTokenFee(e){const t=await this.createTransferTokenTx(e);return this.transactionFee(t)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:t}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(t)}}const Ze=de("transfer",()=>{const s=fe(),e=pe(),t=u(()=>e.tokens),i=P(),{state:d,getUserTokens:f}=P(),p=u(()=>i.certificate),N=u(()=>i.requiredPolicy),F=u(()=>i.certificateValid),A=0,T=me(),{publicKey:E}=J(),{notify:g}=ve(),y=_e("token-transfer",""),n=ke({address:"",value:void 0,loading:!1,token:void 0,fee:A,valid:!1});w(t,()=>{t.value.length&&(console.log("find token ===================== ",t.value.find(a=>a.mint===y.value)),n.token=t.value.find(a=>a.mint===y.value)??t.value[0])},{immediate:!0});function x(){n.value=void 0,n.fee=A}w(()=>n.token,()=>{x(),i.policySpec=n.token?.name??"",console.log("state token ===================== ",n.token),n.token&&(y.value=n.token.mint,console.log("transfer token ===================== ",y.value))}),w(()=>T.value?.publicKey,a=>{a||(x(),n.address="")}),w(()=>n.address,async()=>{n.valid=q(n.address)});const _=u(()=>{const a=n.token?.mint??"";return q(a)?new v(a):""}),b=u(()=>q(n.address)?new v(n.address):""),m=O(),l=O(!1);w([_,b,()=>n.valid],async()=>{if(n.token?.mint===W)return l.value=!0;if(_.value&&b.value&&n.valid)try{return m.value=await V(_.value,b.value),await ge(s.connection,m.value),l.value=!0}catch{l.value=!1}l.value=!1}),w([()=>n.valid,()=>n.value,m],()=>{n.valid&&Number(n.value)>0?I():n.fee=A});const C=u(()=>new Ye(new D(s.connection,T.value??{publicKey:v.default},D.defaultOptions())));async function I(){const a=await ye(T.value?.publicKey,n.address,Number(n.value),s.connection),h=await be(a,s.connection)+H;return n.fee=l.value?h:h+Te}async function R(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",p.value),F.value){let a;n.token?.mint===W?a=await Z():a=await ee(),g({type:"positive",message:"Transaction confirmed",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${a}?cluster=${s.cluster}`,onClick:()=>!1}]}),x(),await f()}else he()}catch(a){console.error("verifyTransfer error: ",a)}finally{n.loading=!1}}async function Z(){if(p.value){const a=new L(Number(n.value)*we),h=new v(n.address);return await C.value.transfer({amount:a,receiver:h,proofRequest:p.value.pubkey,policy:new v(N.value)})}}async function ee(){if(!E.value||!n.token?.mint)return;const a=d.tokens.find(ae=>ae.mint===n.token?.mint);if(!a||!_.value||!b.value||!T.value||!p.value)return;const h=await V(_.value,E.value),se=new L(Number(n.value)*10**a.decimals);return await C.value.transferToken({destination:m.value,source:h,tokenMint:_.value,amount:se,receiver:b.value,proofRequest:p.value.pubkey,policy:new v(N.value)})}function ne(a){n.value=a}function te(a){console.log("set token ======== ",a),n.token=a}return{state:n,setMax:ne,setToken:te,verifyTransfer:R}}),en={class:"swap-form"},nn={class:"swap-field"},tn={class:"swap-field__info"},sn={class:"row"},an=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),on={class:"col row justify-end swap-field__balance q-pr-sm"},rn={key:0,class:"insufficient-error"},cn=r("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),ln={class:"row justify-between",style:{gap:"10px"}},un={class:"transfer-address"},dn=r("div",{class:"col transfer-address__label"}," Address ",-1),fn={class:"swap-info q-mt-md"},pn=r("dt",null,"Transfer fee:",-1),mn={class:"swap-submit"},vn=Se({__name:"TransferCard",setup(s){const{state:e,setMax:t,setToken:i,verifyTransfer:d}=Ze(),{state:f,tokenBalance:p}=P(),{handleSearchToken:N,handleFilterToken:F,tokens:A}=Ae();F(xe);const T=u(()=>[...A.value].sort((m,l)=>p(l.symbol)-p(m.symbol))),{connected:E}=J(),g=u(()=>e.token?.mint?p(e.token.mint):0),y=u(()=>g.value===0),n=u(()=>Number(e.value)>g.value);async function x(){const m=n.value?"Insufficient funds":"Not valid address";if(!e.valid||n.value)return Me.create({type:"negative",timeout:2e3,message:m});d()}function _(){t(g.value),e.token?.mint===W&&(e.value=g.value-qe-3*Fe-H)}const b=u(()=>Number(e.value)>0&&q(e.address));return(m,l)=>{const C=ue,I=le;return B(),Re(Ne,{class:"swap-card transfer-card"},{default:S(()=>[c(j,{class:"swap-card__header"},{default:S(()=>[M(" Transfer ")]),_:1}),c(j,{class:"swap-card__body"},{default:S(()=>[r("div",en,[r("div",nn,[r("div",tn,[r("div",sn,[an,r("div",on,[o(n)?(B(),Y("div",rn," Insufficient funds ")):Ee("",!0),M(" Balance: "+U(o($)(o(g))),1)]),cn])]),r("div",ln,[c(X,{modelValue:o(e).value,"onUpdate:modelValue":l[0]||(l[0]=R=>o(e).value=R),disable:o(y),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:o(ce)},{append:S(()=>[c(Q,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:_},{default:S(()=>[M(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),c(C,{token:o(e).token,disable:!o(E),options:o(T),onHandleSearchToken:o(N),onSetToken:o(i)},null,8,["token","disable","options","onHandleSearchToken","onSetToken"])])])]),r("div",un,[dn,c(X,{modelValue:o(e).address,"onUpdate:modelValue":l[1]||(l[1]=R=>o(e).address=R),disable:o(y),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",fn,[r("dl",null,[pn,r("dd",null,U(o($)(o(e).fee,6)),1)])]),c(I,{class:"q-my-md q-mx-auto"}),r("div",mn,[c(Q,{loading:o(e)?.loading,disable:!o(b),rounded:"",ripple:!1,onClick:x},{default:S(()=>[M(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),c(Ce,{showing:o(f)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),_n={},kn={class:"main-block row justify-center"};function gn(s,e){const t=oe,i=vn,d=ie,f=re;return B(),Y(Pe,null,[c(t,{class:"q-mt-lg"}),r("div",kn,[c(i)]),c(d,{class:"q-mt-lg"}),c(f,{class:"q-mt-lg"})],64)}const Sn=Ie(_n,[["render",gn]]);export{Sn as default};
