import{_ as oe,a as ie,b as re}from"./AppDescriptionTop-ff514580.js";import{o as ce,_ as le}from"./PolicyCard.vue_vue_type_script_setup_true_lang-cacc7f9b.js";import{_ as ue}from"./SelectToken.vue_vue_type_script_setup_true_lang-ce339696.js";import{k,m as K,n as D,S as G,q as J,s as de,u as fe,t as pe,v as l,w as P,x as me,y as H,z as ve,A as _e,B as ke,C as w,F as q,P as S,G as O,H as W,I as V,J as ge,K as L,L as ye,M as be,N as Y,O as Te,Q as he,R as we,U as j,V as Se,W as Ae,X as xe,Y as Re,o as B,Z as Ne,$ as A,a0 as Ee,j as c,a1 as M,a2 as $,a3 as r,a4 as i,i as Z,a5 as Me,a6 as U,a7 as X,a8 as Q,a9 as z,aa as qe,ab as Ce,ac as Fe,ad as Ie,_ as Pe,ae as We}from"./index-ca95064e.js";import{g as Be,T as Ke,a as De,c as Oe,b as Ve}from"./associatedTokenAccount-bf362adb.js";var Le=Object.defineProperty,je=(s,e,t)=>e in s?Le(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$e=(s,e,t)=>(je(s,typeof e!="symbol"?e+"":e,t),t);const Ue=new k.BeetArgsStruct([["instructionDiscriminator",k.uniformFixedSizeArray(k.u8,8)],["amount",k.u64]],"SplTransferInstructionArgs"),Xe=[67,186,237,99,235,243,166,198];function Qe(s,e,t=new K("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=Ue.serialize({instructionDiscriminator:Xe,...e}),u=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.tokenMint,isWritable:!1,isSigner:!1},{pubkey:s.source,isWritable:!0,isSigner:!1},{pubkey:s.destination,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.tokenProgram??Ve,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??G.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const p of s.anchorRemainingAccounts)u.push(p);return new J({programId:t,keys:u,data:o})}const ze=new k.BeetArgsStruct([["instructionDiscriminator",k.uniformFixedSizeArray(k.u8,8)],["amount",k.u64]],"TransferInstructionArgs"),Ge=[163,52,200,231,140,3,69,186];function Je(s,e,t=new K("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=ze.serialize({instructionDiscriminator:Ge,...e}),u=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??G.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const p of s.anchorRemainingAccounts)u.push(p);return new J({programId:t,keys:u,data:o})}const He="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",Ye=new K(He);class Ze{constructor(e){$e(this,"programId",Ye),this.provider=e}get connection(){return this.provider.connection}async transfer(e,t){const o=this.createTransferTx(e);return this.provider.sendAndConfirm(o,[],t)}createTransferTx(e){const t=Je({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new D().add(t)}async getTransferFee(e){const t=this.createTransferTx(e);return this.transactionFee(t)}async transferToken(e,t){const o=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(o,[],t)}async createTransferTokenTx(e){const t=new D;try{await Be(this.connection,e.destination)}catch(o){(o instanceof Ke||o instanceof De)&&t.add(Oe(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return t.add(Qe({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),t}async getTransferTokenFee(e){const t=await this.createTransferTokenTx(e);return this.transactionFee(t)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:t}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(t)}}const en=de("transfer",()=>{const s=fe(),e=pe(),t=l(()=>e.tokens),o=P(),{state:u,getUserTokens:p}=P(),m=l(()=>o.certificate),N=l(()=>o.requiredPolicy),C=l(()=>o.certificateValid),x=0,b=me(),{publicKey:E}=H();ve();const d=_e("token-transfer",""),n=ke({address:"",value:void 0,loading:!1,token:void 0,fee:x,valid:!1});w(t,()=>{t.value.length&&(console.log("find token ===================== ",t.value.find(a=>a.mint===d.value)),n.token=t.value.find(a=>a.mint===d.value)??t.value[0])},{immediate:!0});function g(){n.value=void 0,n.fee=x}w(()=>n.token,()=>{g(),o.policySpec=n.token?.name??"",console.log("state token ===================== ",n.token),n.token&&(d.value=n.token.mint,console.log("transfer token ===================== ",d.value))}),w(()=>b.value?.publicKey,a=>{a||(g(),n.address="")}),w(()=>n.address,async()=>{n.valid=q(n.address)});const _=l(()=>{const a=n.token?.mint??"";return q(a)?new S(a):""}),y=l(()=>q(n.address)?new S(n.address):""),T=O(),f=O(!1);w([_,y,()=>n.valid],async()=>{if(n.token?.mint===W)return f.value=!0;if(_.value&&y.value&&n.valid)try{return T.value=await V(_.value,y.value),await ge(s.connection,T.value),f.value=!0}catch{f.value=!1}f.value=!1}),w([()=>n.valid,()=>n.value,T],()=>{n.valid&&Number(n.value)>0?F():n.fee=x});const v=l(()=>new Ze(new L(s.connection,b.value??{publicKey:S.default},L.defaultOptions())));async function F(){const a=await ye(b.value?.publicKey,n.address,Number(n.value),s.connection),h=await be(a,s.connection)+Y;return n.fee=f.value?h:h+Te}async function I(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",m.value),C.value){let a;n.token?.mint===W?a=await R():a=await ee(),he(`https://explorer.solana.com/tx/${a}?cluster=${s.cluster}`),g(),await p()}else we()}catch(a){console.error("verifyTransfer error: ",a)}finally{n.loading=!1}}async function R(){if(m.value){const a=new j(Number(n.value)*Se),h=new S(n.address);return await v.value.transfer({amount:a,receiver:h,proofRequest:m.value.pubkey,policy:new S(N.value)})}}async function ee(){if(!E.value||!n.token?.mint)return;const a=u.tokens.find(ae=>ae.mint===n.token?.mint);if(!a||!_.value||!y.value||!b.value||!m.value)return;const h=await V(_.value,E.value),se=new j(Number(n.value)*10**a.decimals);return await v.value.transferToken({destination:T.value,source:h,tokenMint:_.value,amount:se,receiver:y.value,proofRequest:m.value.pubkey,policy:new S(N.value)})}function ne(a){n.value=a}function te(a){console.log("set token ======== ",a),n.token=a}return{state:n,setMax:ne,setToken:te,verifyTransfer:I}}),nn={class:"swap-form"},tn={class:"swap-field"},sn={class:"swap-field__info"},an={class:"row"},on=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),rn={class:"col row justify-end swap-field__balance q-pr-sm"},cn={key:0,class:"insufficient-error"},ln=r("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),un={class:"row justify-between",style:{gap:"10px"}},dn={class:"transfer-address"},fn=r("div",{class:"col transfer-address__label"}," Address ",-1),pn={class:"swap-info q-mt-md"},mn=r("dt",null,"Transfer fee:",-1),vn={class:"swap-submit"},_n=Ae({__name:"TransferCard",setup(s){const{state:e,setMax:t,setToken:o,verifyTransfer:u}=en(),{state:p,tokenBalance:m}=P(),{handleSearchToken:N,handleFilterToken:C,tokens:x}=xe();C(Re);const b=l(()=>[...x.value].sort((f,v)=>m(v.symbol)-m(f.symbol))),{connected:E}=H(),d=l(()=>e.token?.mint?m(e.token.mint):0),n=l(()=>d.value===0),g=l(()=>Number(e.value)>d.value);async function _(){const f=g.value?"Insufficient funds":"Not valid address";if(!e.valid||g.value)return Ce.create({type:"negative",timeout:2e3,message:f});u()}function y(){t(d.value),e.token?.mint===W&&(e.value=d.value-Fe-3*Ie-Y)}const T=l(()=>E.value&&Number(e.value)>0&&q(e.address));return(f,v)=>{const F=ue,I=le;return B(),Ne(Ee,{class:"swap-card transfer-card"},{default:A(()=>[c($,{class:"swap-card__header"},{default:A(()=>[M(" Transfer ")]),_:1}),c($,{class:"swap-card__body"},{default:A(()=>[r("div",nn,[r("div",tn,[r("div",sn,[r("div",an,[on,r("div",rn,[i(g)?(B(),Z("div",cn," Insufficient funds ")):Me("",!0),M(" Balance: "+U(i(X)(i(d))),1)]),ln])]),r("div",un,[c(Q,{modelValue:i(e).value,"onUpdate:modelValue":v[0]||(v[0]=R=>i(e).value=R),disable:i(n),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:i(ce)},{append:A(()=>[c(z,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:y},{default:A(()=>[M(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),c(F,{token:i(e).token,options:i(b),onHandleSearchToken:i(N),onSetToken:i(o)},null,8,["token","options","onHandleSearchToken","onSetToken"])])])]),r("div",dn,[fn,c(Q,{modelValue:i(e).address,"onUpdate:modelValue":v[1]||(v[1]=R=>i(e).address=R),disable:i(n),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",pn,[r("dl",null,[mn,r("dd",null,U(i(X)(i(e).fee,6)),1)])]),c(I,{class:"q-my-md q-mx-auto"}),r("div",vn,[c(z,{loading:i(e)?.loading,disable:!i(T),rounded:"",ripple:!1,onClick:_},{default:A(()=>[M(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),c(qe,{showing:i(p)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),kn={},gn={class:"main-block row justify-center"};function yn(s,e){const t=oe,o=_n,u=ie,p=re;return B(),Z(We,null,[c(t,{class:"q-mt-lg"}),r("div",gn,[c(o)]),c(u,{class:"q-mt-lg"}),c(p,{class:"q-mt-lg"})],64)}const An=Pe(kn,[["render",yn]]);export{An as default};
