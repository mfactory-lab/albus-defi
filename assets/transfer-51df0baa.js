import{_ as ae,a as oe,b as ie}from"./AppDescriptionTop-d072e173.js";import{o as re,_ as ce}from"./PolicyCard.vue_vue_type_script_setup_true_lang-74b43713.js";import{_ as le}from"./SelectToken.vue_vue_type_script_setup_true_lang-3f0069b3.js";import{k,P as v,m as W,S as Q,n as z,q as ue,u as de,s as fe,t as u,v as I,w as pe,x as G,y as me,z as ve,A as h,B as q,C as K,F as B,G as V,H as _e,I as O,J as ye,K as ke,L as J,M as ge,N as be,O as j,Q as Te,R as he,U as we,o as P,V as Se,W as w,X as Ae,j as c,Y as E,Z as D,$ as r,a0 as i,i as H,a1 as xe,a2 as L,a3 as U,a4 as $,a5 as X,a6 as Re,a7 as Ne,a8 as Ce,a9 as Ee,_ as qe,aa as Me}from"./index-2f041995.js";import{g as Fe,T as Ie,a as Be,c as Pe,b as We}from"./associatedTokenAccount-f90a9496.js";var Ke=Object.defineProperty,Ve=(t,e,s)=>e in t?Ke(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Oe=(t,e,s)=>(Ve(t,typeof e!="symbol"?e+"":e,s),s);const je=new k.BeetArgsStruct([["instructionDiscriminator",k.uniformFixedSizeArray(k.u8,8)],["amount",k.u64]],"SplTransferInstructionArgs"),De=[67,186,237,99,235,243,166,198];function Le(t,e,s=new v("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=je.serialize({instructionDiscriminator:De,...e}),d=[{pubkey:t.sender,isWritable:!0,isSigner:!0},{pubkey:t.receiver,isWritable:!0,isSigner:!1},{pubkey:t.tokenMint,isWritable:!1,isSigner:!1},{pubkey:t.source,isWritable:!0,isSigner:!1},{pubkey:t.destination,isWritable:!0,isSigner:!1},{pubkey:t.policy,isWritable:!1,isSigner:!1},{pubkey:t.proofRequest,isWritable:!1,isSigner:!1},{pubkey:t.tokenProgram??We,isWritable:!1,isSigner:!1},{pubkey:t.systemProgram??Q.programId,isWritable:!1,isSigner:!1}];if(t.anchorRemainingAccounts!=null)for(const f of t.anchorRemainingAccounts)d.push(f);return new z({programId:s,keys:d,data:o})}const Ue=new k.BeetArgsStruct([["instructionDiscriminator",k.uniformFixedSizeArray(k.u8,8)],["amount",k.u64]],"TransferInstructionArgs"),$e=[163,52,200,231,140,3,69,186];function Xe(t,e,s=new v("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=Ue.serialize({instructionDiscriminator:$e,...e}),d=[{pubkey:t.sender,isWritable:!0,isSigner:!0},{pubkey:t.receiver,isWritable:!0,isSigner:!1},{pubkey:t.policy,isWritable:!1,isSigner:!1},{pubkey:t.proofRequest,isWritable:!1,isSigner:!1},{pubkey:t.systemProgram??Q.programId,isWritable:!1,isSigner:!1}];if(t.anchorRemainingAccounts!=null)for(const f of t.anchorRemainingAccounts)d.push(f);return new z({programId:s,keys:d,data:o})}const Qe="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",ze=new v(Qe);class Ge{constructor(e){Oe(this,"programId",ze),this.provider=e}get connection(){return this.provider.connection}async transfer(e,s){const o=this.createTransferTx(e);return this.provider.sendAndConfirm(o,[],s)}createTransferTx(e){const s=Xe({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new W().add(s)}async getTransferFee(e){const s=this.createTransferTx(e);return this.transactionFee(s)}async transferToken(e,s){const o=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(o,[],s)}async createTransferTokenTx(e){const s=new W;try{await Fe(this.connection,e.destination)}catch(o){(o instanceof Ie||o instanceof Be)&&s.add(Pe(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return s.add(Le({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),s}async getTransferTokenFee(e){const s=await this.createTransferTokenTx(e);return this.transactionFee(s)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:s}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(s)}}const Je=ue("transfer",()=>{const t=de(),e=fe(),s=u(()=>e.tokens),o=I(),{state:d,getUserTokens:f}=I(),p=u(()=>o.certificate),R=u(()=>o.requiredPolicy),M=u(()=>o.certificateValid),S=0,b=pe(),{publicKey:_}=G(),{notify:N}=me(),n=ve({address:"",value:void 0,loading:!1,token:void 0,fee:S,valid:!1});h(s,()=>{!n.token&&s.value[0]&&(n.token=s.value[0])},{immediate:!0});function A(){n.value=void 0,n.fee=S}h(()=>n.token,()=>{A(),o.policySpec=n.token?.name??""}),h(()=>b.value?.publicKey,a=>{a||(A(),n.address="")}),h(()=>n.address,async()=>{n.valid=q(n.address)});const y=u(()=>{const a=n.token?.mint??"";return q(a)?new v(a):""}),g=u(()=>q(n.address)?new v(n.address):""),m=K(),l=K(!1);h([y,g,()=>n.valid],async()=>{if(n.token?.mint===B)return l.value=!0;if(y.value&&g.value&&n.valid)try{return m.value=await V(y.value,g.value),await _e(t.connection,m.value),l.value=!0}catch{l.value=!1}l.value=!1}),h([()=>n.valid,()=>n.value,m],()=>{n.valid&&Number(n.value)>0?F():n.fee=S});const C=u(()=>new Ge(new O(t.connection,b.value??{publicKey:v.default},O.defaultOptions())));async function F(){const a=await ye(b.value?.publicKey,n.address,Number(n.value),t.connection),T=await ke(a,t.connection)+J;return n.fee=l.value?T:T+ge}async function x(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",p.value),M.value){let a;n.token?.mint===B?a=await Y():a=await Z(),N({type:"positive",message:"Transaction confirmed",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${a}?cluster=${t.cluster}`,onClick:()=>!1}]}),A(),await f()}else be()}catch(a){console.error("verifyTransfer error: ",a)}finally{n.loading=!1}}async function Y(){if(p.value){const a=new j(Number(n.value)*Te),T=new v(n.address);return await C.value.transfer({amount:a,receiver:T,proofRequest:p.value.pubkey,policy:new v(R.value)})}}async function Z(){if(!_.value||!n.token?.mint)return;const a=d.tokens.find(se=>se.mint===n.token?.mint);if(!a||!y.value||!g.value||!b.value||!p.value)return;const T=await V(y.value,_.value),te=new j(Number(n.value)*10**a.decimals);return await C.value.transferToken({destination:m.value,source:T,tokenMint:y.value,amount:te,receiver:g.value,proofRequest:p.value.pubkey,policy:new v(R.value)})}function ee(a){n.value=a}function ne(a){n.token=a}return{state:n,setMax:ee,setToken:ne,verifyTransfer:x}}),He={class:"swap-form"},Ye={class:"swap-field"},Ze={class:"swap-field__info"},en={class:"row"},nn=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),tn={class:"col row justify-end swap-field__balance q-pr-sm"},sn={key:0,class:"insufficient-error"},an=r("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),on={class:"row justify-between",style:{gap:"10px"}},rn={class:"transfer-address"},cn=r("div",{class:"col transfer-address__label"}," Address ",-1),ln={class:"swap-info q-mt-md"},un=r("dt",null,"Transfer fee:",-1),dn={class:"swap-submit"},fn=he({__name:"TransferCard",setup(t){const{state:e,setMax:s,setToken:o,verifyTransfer:d}=Je(),{state:f,tokenBalance:p}=I(),{handleSearchToken:R,tokens:M}=we(),S=u(()=>[...M.value].sort((m,l)=>p(l.symbol)-p(m.symbol))),{connected:b}=G(),_=u(()=>e.token?.mint?p(e.token.mint):0),N=u(()=>_.value===0),n=u(()=>Number(e.value)>_.value);async function A(){const m=n.value?"Insufficient funds":"Not valid address";if(!e.valid||n.value)return Ne.create({type:"negative",timeout:2e3,message:m});d()}function y(){s(_.value),e.token?.mint===B&&(e.value=_.value-Ce-3*Ee-J)}const g=u(()=>Number(e.value)>0&&q(e.address));return(m,l)=>{const C=le,F=ce;return P(),Se(Ae,{class:"swap-card transfer-card"},{default:w(()=>[c(D,{class:"swap-card__header"},{default:w(()=>[E(" Transfer ")]),_:1}),c(D,{class:"swap-card__body"},{default:w(()=>[r("div",He,[r("div",Ye,[r("div",Ze,[r("div",en,[nn,r("div",tn,[i(n)?(P(),H("div",sn," Insufficient funds ")):xe("",!0),E(" Balance: "+L(i(U)(i(_))),1)]),an])]),r("div",on,[c($,{modelValue:i(e).value,"onUpdate:modelValue":l[0]||(l[0]=x=>i(e).value=x),disable:i(N),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:i(re)},{append:w(()=>[c(X,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:y},{default:w(()=>[E(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),c(C,{disable:!i(b),options:i(S),onHandleSearchToken:i(R),onSetToken:i(o)},null,8,["disable","options","onHandleSearchToken","onSetToken"])])])]),r("div",rn,[cn,c($,{modelValue:i(e).address,"onUpdate:modelValue":l[1]||(l[1]=x=>i(e).address=x),disable:i(N),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",ln,[r("dl",null,[un,r("dd",null,L(i(U)(i(e).fee,6)),1)])]),c(F,{class:"q-my-md q-mx-auto"}),r("div",dn,[c(X,{loading:i(e)?.loading,disable:!i(g),rounded:"",ripple:!1,onClick:A},{default:w(()=>[E(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),c(Re,{showing:i(f)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),pn={},mn={class:"main-block row justify-center"};function vn(t,e){const s=ae,o=fn,d=oe,f=ie;return P(),H(Me,null,[c(s,{class:"q-mt-lg"}),r("div",mn,[c(o)]),c(d,{class:"q-mt-lg"}),c(f,{class:"q-mt-lg"})],64)}const Tn=qe(pn,[["render",vn]]);export{Tn as default};
