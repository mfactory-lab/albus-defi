import{Q as B,o as oe,_ as ie,a as re,b as ce}from"./AppDescriptionTop-0d63e378.js";import{k as b,P as m,m as P,n as D,q as le,s as ue,t as de,u as fe,S as J,v as $,w as pe,x as ve,y as me,z as M,A as f,B as _e,C as z,F as ye,G as W,H as F,I as E,J as K,K as V,L as q,M as be,N as ke,O as Z,Q as ge,R as we,U,V as he,W as Te,X as Se,Y as Ae,o as I,Z as xe,$ as h,a0 as Fe,j as d,a1 as C,a2 as O,a3 as r,a4 as o,i as G,a5 as Ne,a6 as Q,a7 as L,a8 as j,a9 as Re,aa as Ce,ab as Ee,ac as Me,_ as Ie,ad as Be}from"./index-461c5ff6.js";var Pe=Object.defineProperty,We=(s,e,a)=>e in s?Pe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[e]=a,Ke=(s,e,a)=>(We(s,typeof e!="symbol"?e+"":e,a),a);const Ve=new b.BeetArgsStruct([["instructionDiscriminator",b.uniformFixedSizeArray(b.u8,8)],["amount",b.u64]],"SplTransferInstructionArgs"),qe=[67,186,237,99,235,243,166,198];function Ue(s,e,a=new m("J4pyN7p9dAovEQKoZJV1jUbM3FrCBPLCS2dyiRUnwi5c")){const[i]=Ve.serialize({instructionDiscriminator:qe,...e}),u=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.tokenMint,isWritable:!1,isSigner:!1},{pubkey:s.source,isWritable:!0,isSigner:!1},{pubkey:s.destination,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.tokenProgram??fe,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??J.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const l of s.anchorRemainingAccounts)u.push(l);return new $({programId:a,keys:u,data:i})}const Oe=new b.BeetArgsStruct([["instructionDiscriminator",b.uniformFixedSizeArray(b.u8,8)],["amount",b.u64]],"TransferInstructionArgs"),Qe=[163,52,200,231,140,3,69,186];function Le(s,e,a=new m("J4pyN7p9dAovEQKoZJV1jUbM3FrCBPLCS2dyiRUnwi5c")){const[i]=Oe.serialize({instructionDiscriminator:Qe,...e}),u=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??J.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const l of s.anchorRemainingAccounts)u.push(l);return new $({programId:a,keys:u,data:i})}const je="J4pyN7p9dAovEQKoZJV1jUbM3FrCBPLCS2dyiRUnwi5c",De=new m(je);class Je{constructor(e){Ke(this,"programId",De),this.provider=e}get connection(){return this.provider.connection}async transfer(e,a){const i=this.createTransferTx(e);return this.provider.sendAndConfirm(i,[],a)}createTransferTx(e){const a=Le({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new P().add(a)}async getTransferFee(e){const a=this.createTransferTx(e);return this.transactionFee(a)}async transferToken(e,a){const i=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(i,[],a)}async createTransferTokenTx(e){const a=new P;try{await D(this.connection,e.destination)}catch(i){(i instanceof le||i instanceof ue)&&a.add(de(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return a.add(Ue({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),a}async getTransferTokenFee(e){const a=await this.createTransferTokenTx(e);return this.transactionFee(a)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:a}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(a)}}const $e=pe("transfer",()=>{const s=ve(),{tokens:e}=me(),a=M(),{state:i,getUserTokens:u}=M(),l=f(()=>a.certificate),N=f(()=>a.requiredPolicy),T=f(()=>a.certificateValid),S=0,k=_e(),{publicKey:_}=z(),{notify:R}=ye(),A=W(e[0]),n=W({address:"",value:void 0,loading:!1,token:A,fee:S,valid:!1});function x(){n.value=void 0,n.fee=S}F(()=>n.token,()=>{x(),a.policySpec=n.token.name}),F(()=>k.value?.publicKey,t=>{t||(x(),n.address="")}),F(()=>n.address,async()=>{n.valid=E(n.address)});const y=f(()=>{const t=n.token.mint??"";return E(t)?new m(t):""}),p=f(()=>E(n.address)?new m(n.address):""),c=K(),v=K(!1);F([y,p,()=>n.valid],async()=>{if(n.token.label==="sol")return v.value=!0;if(y.value&&p.value&&n.valid)try{return c.value=await V(y.value,p.value),await D(s.connection,c.value),v.value=!0}catch{v.value=!1}v.value=!1}),F([()=>n.valid,()=>n.value,c],()=>{n.valid&&Number(n.value)>0?X():n.fee=S});const g=f(()=>new Je(new q(s.connection,k.value??{publicKey:m.default},q.defaultOptions())));async function X(){const t=await be(k.value?.publicKey,n.address,Number(n.value),s.connection),w=await ke(t,s.connection)+Z;return n.fee=v.value?w:w+ge}async function H(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",l.value),T.value){let t;n.token.label==="sol"?t=await Y():t=await ee(),R({type:"positive",message:"Transaction confirmed",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${t}?cluster=${s.cluster}`,onClick:()=>!1}]}),x(),await u()}else we()}catch(t){console.error("verifyTransfer error: ",t)}finally{n.loading=!1}}async function Y(){if(l.value){const t=new U(Number(n.value)*he),w=new m(n.address);return await g.value.transfer({amount:t,receiver:w,proofRequest:l.value.pubkey,policy:new m(N.value)})}}async function ee(){if(!_.value||!n.token.mint)return;const t=i.tokens.find(te=>te.mint===n.token.mint);if(!t||!y.value||!p.value||!k.value||!l.value)return;const w=await V(y.value,_.value),ae=new U(Number(n.value)*10**t.decimals);return await g.value.transferToken({destination:c.value,source:w,tokenMint:y.value,amount:ae,receiver:p.value,proofRequest:l.value.pubkey,policy:new m(N.value)})}function ne(t){n.value=t}function se(t){n.token=t}return{state:n,setMax:ne,setToken:se,verifyTransfer:H}}),ze={class:"swap-form"},Ze={class:"swap-field"},Ge={class:"swap-field__info"},Xe={class:"row"},He=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),Ye={class:"col row justify-end swap-field__balance q-pr-sm"},en={key:0,class:"insufficient-error"},nn=r("div",{class:"col-3 swap-field__label q-pl-sm"}," ASSET ",-1),sn={class:"row justify-between",style:{gap:"10px"}},an={class:"transfer-address"},tn=r("div",{class:"col transfer-address__label"}," Address ",-1),on={class:"swap-info"},rn=r("dt",null,"Transfer fee:",-1),cn={class:"swap-submit transfer-submit"},ln=Te({__name:"TransferCard",setup(s){const{state:e,setMax:a,setToken:i,verifyTransfer:u}=$e(),{state:l,tokenBalance:N}=M(),{tokens:T}=Se(),S=f(()=>T.value.filter(c=>l.tokens.find(v=>c.name===Ae(v.symbol))).length!==0?T.value:[T.value.find(c=>c.symbol==="sol")]),{connected:k}=z(),_=f(()=>N(e.token.label)),R=f(()=>_.value===0),A=f(()=>Number(e.value)>_.value);async function n(){const p=A.value?"Insufficient funds":"Not valid address";if(!e.valid||A.value)return Ce.create({type:"negative",timeout:2e3,message:p});u()}function x(){a(_.value),e.token.value==="sol"&&(e.value=_.value-Ee-3*Me-Z)}const y=f(()=>Number(e.value)>0&&E(e.address));return(p,c)=>{const v=ie;return I(),xe(Fe,{class:"swap-card transfer-card"},{default:h(()=>[d(O,{class:"swap-card__header"},{default:h(()=>[C(" Transfer ")]),_:1}),d(O,{class:"swap-card__body"},{default:h(()=>[r("div",ze,[r("div",Ze,[r("div",Ge,[r("div",Xe,[He,r("div",Ye,[o(A)?(I(),G("div",en," Insufficient funds ")):Ne("",!0),C(" Balance: "+Q(o(L)(o(_))),1)]),nn])]),r("div",sn,[d(B,{modelValue:o(e).value,"onUpdate:modelValue":c[0]||(c[0]=g=>o(e).value=g),disable:o(R),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:o(oe)},{append:h(()=>[d(j,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:x},{default:h(()=>[C(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),d(v,{disable:!o(k),options:o(S),onSetToken:o(i)},null,8,["disable","options","onSetToken"])])])]),r("div",an,[tn,d(B,{modelValue:o(e).address,"onUpdate:modelValue":c[1]||(c[1]=g=>o(e).address=g),disable:o(R),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",on,[r("dl",null,[rn,r("dd",null,Q(o(L)(o(e).fee,6)),1)])]),r("div",cn,[d(j,{loading:o(e)?.loading,disable:!o(y),rounded:"",ripple:!1,onClick:n},{default:h(()=>[C(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),d(Re,{showing:o(l)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),un={},dn={class:"main-block row justify-center"};function fn(s,e){const a=re,i=ln,u=ce;return I(),G(Be,null,[d(a,{class:"q-mt-xl"}),r("div",dn,[d(i)]),d(u,{class:"q-mt-lg"})],64)}const mn=Ie(un,[["render",fn]]);export{mn as default};
