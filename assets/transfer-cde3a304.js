import{_ as ie,a as re}from"./AppDescription-b5d380f1.js";import{_ as ce}from"./PolicyCard.vue_vue_type_script_setup_true_lang-844e6cdc.js";import{o as le,_ as ue}from"./SelectToken.vue_vue_type_script_setup_true_lang-645bdb29.js";import{m as g,P as _,n as O,q as G,s as de,t as fe,u as pe,v as me,S as J,w as H,x as ve,y as _e,z as ke,A as l,B,C as ge,F as Y,G as ye,H as be,I as Te,J as S,K as M,L as V,M as W,N as j,O as D,Q as he,R as we,U as Z,V as Se,W as Ae,X as L,Y as xe,Z as Ne,$ as Re,a0 as Ee,a1 as Ce,o as K,a2 as qe,a3 as A,a4 as Me,k as c,a5 as q,a6 as U,a7 as r,a8 as o,j as ee,a9 as Fe,aa as $,ab as X,ac as Q,ad as z,ae as Ie,af as Pe,ag as Be,ah as We,_ as Ke,ai as Oe}from"./index-28d1d492.js";import{_ as Ve}from"./AppDescriptionTop-71a1630d.js";var je=Object.defineProperty,De=(s,e,t)=>e in s?je(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Le=(s,e,t)=>(De(s,typeof e!="symbol"?e+"":e,t),t);const Ue=new g.BeetArgsStruct([["instructionDiscriminator",g.uniformFixedSizeArray(g.u8,8)],["amount",g.u64]],"SplTransferInstructionArgs"),$e=[67,186,237,99,235,243,166,198];function Xe(s,e,t=new _("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[i]=Ue.serialize({instructionDiscriminator:$e,...e}),u=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.tokenMint,isWritable:!1,isSigner:!1},{pubkey:s.source,isWritable:!0,isSigner:!1},{pubkey:s.destination,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.tokenProgram??me,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??J.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const p of s.anchorRemainingAccounts)u.push(p);return new H({programId:t,keys:u,data:i})}const Qe=new g.BeetArgsStruct([["instructionDiscriminator",g.uniformFixedSizeArray(g.u8,8)],["amount",g.u64]],"TransferInstructionArgs"),ze=[163,52,200,231,140,3,69,186];function Ge(s,e,t=new _("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[i]=Qe.serialize({instructionDiscriminator:ze,...e}),u=[{pubkey:s.sender,isWritable:!0,isSigner:!0},{pubkey:s.receiver,isWritable:!0,isSigner:!1},{pubkey:s.policy,isWritable:!1,isSigner:!1},{pubkey:s.proofRequest,isWritable:!1,isSigner:!1},{pubkey:s.systemProgram??J.programId,isWritable:!1,isSigner:!1}];if(s.anchorRemainingAccounts!=null)for(const p of s.anchorRemainingAccounts)u.push(p);return new H({programId:t,keys:u,data:i})}const Je="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",He=new _(Je);class Ye{constructor(e){Le(this,"programId",He),this.provider=e}get connection(){return this.provider.connection}async transfer(e,t){const i=this.createTransferTx(e);return this.provider.sendAndConfirm(i,[],t)}createTransferTx(e){const t=Ge({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new O().add(t)}async getTransferFee(e){const t=this.createTransferTx(e);return this.transactionFee(t)}async transferToken(e,t){const i=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(i,[],t)}async createTransferTokenTx(e){const t=new O;try{await G(this.connection,e.destination)}catch(i){(i instanceof de||i instanceof fe)&&t.add(pe(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return t.add(Xe({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),t}async getTransferTokenFee(e){const t=await this.createTransferTokenTx(e);return this.transactionFee(t)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:t}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(t)}}const Ze=ve("transfer",()=>{const s=_e(),e=ke(),t=l(()=>e.tokens),i=B(),{state:u,getUserTokens:p}=B(),m=l(()=>i.certificate),R=l(()=>i.requiredPolicy),F=l(()=>i.certificateValid),x=0,T=ge(),{publicKey:E}=Y(),{notify:C}=ye(),d=be("token-transfer",""),n=Te({address:"",value:void 0,loading:!1,token:void 0,fee:x,valid:!1});S(t,()=>{t.value.length&&(console.log("find token ===================== ",t.value.find(a=>a.mint===d.value)),n.token=t.value.find(a=>a.mint===d.value)??t.value[0])},{immediate:!0});function y(){n.value=void 0,n.fee=x}S(()=>n.token,()=>{y(),i.policySpec=n.token?.name??"",console.log("state token ===================== ",n.token),n.token&&(d.value=n.token.mint,console.log("transfer token ===================== ",d.value))}),S(()=>T.value?.publicKey,a=>{a||(y(),n.address="")}),S(()=>n.address,async()=>{n.valid=M(n.address)});const k=l(()=>{const a=n.token?.mint??"";return M(a)?new _(a):""}),b=l(()=>M(n.address)?new _(n.address):""),h=V(),f=V(!1);S([k,b,()=>n.valid],async()=>{if(n.token?.mint===W)return f.value=!0;if(k.value&&b.value&&n.valid)try{return h.value=await j(k.value,b.value),await G(s.connection,h.value),f.value=!0}catch{f.value=!1}f.value=!1}),S([()=>n.valid,()=>n.value,h],()=>{n.valid&&Number(n.value)>0?I():n.fee=x});const v=l(()=>new Ye(new D(s.connection,T.value??{publicKey:_.default},D.defaultOptions())));async function I(){const a=await he(T.value?.publicKey,n.address,Number(n.value),s.connection),w=await we(a,s.connection)+Z;return n.fee=f.value?w:w+Se}async function P(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",m.value),F.value){let a;n.token?.mint===W?a=await N():a=await ne(),C({message:"Transaction confirmed",type:"positive",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${a}?cluster=${s.cluster}`,onClick:()=>!1}]}),y(),await p()}else Ae()}catch(a){console.error("verifyTransfer error: ",a),`${a}`.includes("User rejected the request")||C({type:"negative",message:`${a}`})}finally{n.loading=!1}}async function N(){if(m.value){const a=new L(Number(n.value)*xe),w=new _(n.address);return await v.value.transfer({amount:a,receiver:w,proofRequest:m.value.pubkey,policy:new _(R.value)})}}async function ne(){if(!E.value||!n.token?.mint)return;const a=u.tokens.find(oe=>oe.mint===n.token?.mint);if(!a||!k.value||!b.value||!T.value||!m.value)return;const w=await j(k.value,E.value),ae=new L(Number(n.value)*10**a.decimals);return await v.value.transferToken({destination:h.value,source:w,tokenMint:k.value,amount:ae,receiver:b.value,proofRequest:m.value.pubkey,policy:new _(R.value)})}function te(a){n.value=a}function se(a){console.log("set token ======== ",a),n.token=a}return{state:n,setMax:te,setToken:se,verifyTransfer:P}}),en={class:"swap-form"},nn={class:"swap-field"},tn={class:"swap-field__info"},sn={class:"row"},an=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),on={class:"col row justify-end swap-field__balance q-pr-sm"},rn={key:0,class:"insufficient-error"},cn=r("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),ln={class:"row justify-between",style:{gap:"10px"}},un={class:"transfer-address"},dn=r("div",{class:"col transfer-address__label"}," Address ",-1),fn={class:"swap-info q-mt-md"},pn=r("dt",null,"Transfer fee:",-1),mn={class:"swap-submit"},vn=Ne({__name:"TransferCard",setup(s){const{state:e,setMax:t,setToken:i,verifyTransfer:u}=Ze(),{state:p,tokenBalance:m}=B(),{handleSearchToken:R,handleFilterToken:F,tokens:x}=Re();F(Ee);const{certificateExpired:T}=Ce(),E=l(()=>[...x.value].sort((f,v)=>m(v.symbol)-m(f.symbol))),{connected:C}=Y(),d=l(()=>e.token?.mint?m(e.token.mint):0),n=l(()=>d.value===0),y=l(()=>Number(e.value)>d.value);async function k(){const f=y.value?"Insufficient funds":"Not valid address";if(!e.valid||y.value)return Pe.create({type:"negative",timeout:2e3,message:f});u()}function b(){t(d.value),e.token?.mint===W&&(e.value=d.value-Be-3*We-Z)}const h=l(()=>C.value&&Number(e.value)>0&&M(e.address));return(f,v)=>{const I=ue,P=ce;return K(),qe(Me,{class:"swap-card transfer-card"},{default:A(()=>[c(U,{class:"swap-card__header"},{default:A(()=>[q(" Transfer ")]),_:1}),c(U,{class:"swap-card__body"},{default:A(()=>[r("div",en,[r("div",nn,[r("div",tn,[r("div",sn,[an,r("div",on,[o(y)?(K(),ee("div",rn," Insufficient funds ")):Fe("",!0),q(" Balance: "+$(o(X)(o(d))),1)]),cn])]),r("div",ln,[c(Q,{modelValue:o(e).value,"onUpdate:modelValue":v[0]||(v[0]=N=>o(e).value=N),disable:o(n),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:o(le)},{append:A(()=>[c(z,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:b},{default:A(()=>[q(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),c(I,{token:o(e).token,options:o(E),onHandleSearchToken:o(R),onSetToken:o(i)},null,8,["token","options","onHandleSearchToken","onSetToken"])])])]),r("div",un,[dn,c(Q,{modelValue:o(e).address,"onUpdate:modelValue":v[1]||(v[1]=N=>o(e).address=N),disable:o(n),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",fn,[r("dl",null,[pn,r("dd",null,$(o(X)(o(e).fee,6)),1)])]),c(P,{class:"q-my-md q-mx-auto"}),r("div",mn,[c(z,{loading:o(e)?.loading,disable:!o(h)||o(T),rounded:"",ripple:!1,onClick:k},{default:A(()=>[q(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),c(Ie,{showing:o(p)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),_n={},kn={class:"main-block row justify-center"};function gn(s,e){const t=Ve,i=vn,u=ie,p=re;return K(),ee(Oe,null,[c(t,{class:"q-mt-lg"}),r("div",kn,[c(i)]),c(u,{class:"q-mt-lg"}),c(p,{class:"q-mt-lg"})],64)}const Sn=Ke(_n,[["render",gn]]);export{Sn as default};
