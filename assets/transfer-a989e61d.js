import{_ as ae,a as oe,b as ie}from"./AppDescriptionTop-7d9ca2a0.js";import{o as re,_ as ce}from"./PolicyCard.vue_vue_type_script_setup_true_lang-c9bb5a38.js";import{_ as le}from"./SelectToken.vue_vue_type_script_setup_true_lang-90c54aa6.js";import{k as y,P as v,m as B,S as z,n as G,q as ue,u as de,s as fe,t as l,v as P,w as pe,x as J,y as me,z as ve,A as S,B as C,C as K,F as O,G as V,H as _e,I as D,J as ye,K as ke,L as H,M as be,N as ge,O as L,Q as Te,R as he,U as we,W as Se,o as W,V as Ae,X as A,Y as xe,j as c,Z as M,$ as j,a0 as r,a1 as i,i as Y,a2 as Ne,a3 as $,a4 as U,a5 as X,a6 as Q,a7 as Re,a8 as Ee,a9 as Me,aa as Ce,_ as qe,ab as Fe}from"./index-dec11783.js";import{g as Ie,T as Pe,a as We,c as Be,b as Ke}from"./associatedTokenAccount-7d683dc6.js";var Oe=Object.defineProperty,Ve=(t,e,s)=>e in t?Oe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,De=(t,e,s)=>(Ve(t,typeof e!="symbol"?e+"":e,s),s);const Le=new y.BeetArgsStruct([["instructionDiscriminator",y.uniformFixedSizeArray(y.u8,8)],["amount",y.u64]],"SplTransferInstructionArgs"),je=[67,186,237,99,235,243,166,198];function $e(t,e,s=new v("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=Le.serialize({instructionDiscriminator:je,...e}),u=[{pubkey:t.sender,isWritable:!0,isSigner:!0},{pubkey:t.receiver,isWritable:!0,isSigner:!1},{pubkey:t.tokenMint,isWritable:!1,isSigner:!1},{pubkey:t.source,isWritable:!0,isSigner:!1},{pubkey:t.destination,isWritable:!0,isSigner:!1},{pubkey:t.policy,isWritable:!1,isSigner:!1},{pubkey:t.proofRequest,isWritable:!1,isSigner:!1},{pubkey:t.tokenProgram??Ke,isWritable:!1,isSigner:!1},{pubkey:t.systemProgram??z.programId,isWritable:!1,isSigner:!1}];if(t.anchorRemainingAccounts!=null)for(const f of t.anchorRemainingAccounts)u.push(f);return new G({programId:s,keys:u,data:o})}const Ue=new y.BeetArgsStruct([["instructionDiscriminator",y.uniformFixedSizeArray(y.u8,8)],["amount",y.u64]],"TransferInstructionArgs"),Xe=[163,52,200,231,140,3,69,186];function Qe(t,e,s=new v("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[o]=Ue.serialize({instructionDiscriminator:Xe,...e}),u=[{pubkey:t.sender,isWritable:!0,isSigner:!0},{pubkey:t.receiver,isWritable:!0,isSigner:!1},{pubkey:t.policy,isWritable:!1,isSigner:!1},{pubkey:t.proofRequest,isWritable:!1,isSigner:!1},{pubkey:t.systemProgram??z.programId,isWritable:!1,isSigner:!1}];if(t.anchorRemainingAccounts!=null)for(const f of t.anchorRemainingAccounts)u.push(f);return new G({programId:s,keys:u,data:o})}const ze="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",Ge=new v(ze);class Je{constructor(e){De(this,"programId",Ge),this.provider=e}get connection(){return this.provider.connection}async transfer(e,s){const o=this.createTransferTx(e);return this.provider.sendAndConfirm(o,[],s)}createTransferTx(e){const s=Qe({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new B().add(s)}async getTransferFee(e){const s=this.createTransferTx(e);return this.transactionFee(s)}async transferToken(e,s){const o=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(o,[],s)}async createTransferTokenTx(e){const s=new B;try{await Ie(this.connection,e.destination)}catch(o){(o instanceof Pe||o instanceof We)&&s.add(Be(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return s.add($e({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),s}async getTransferTokenFee(e){const s=await this.createTransferTokenTx(e);return this.transactionFee(s)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:s}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(s)}}const He=ue("transfer",()=>{const t=de(),e=fe(),s=l(()=>e.tokens),o=P(),{state:u,getUserTokens:f}=P(),p=l(()=>o.certificate),R=l(()=>o.requiredPolicy),q=l(()=>o.certificateValid),x=0,T=pe(),{publicKey:E}=J(),{notify:k}=me(),n=ve({address:"",value:void 0,loading:!1,token:void 0,fee:x,valid:!1});S(s,()=>{!n.token&&s.value[0]&&(n.token=s.value[0])},{immediate:!0});function b(){n.value=void 0,n.fee=x}S(()=>n.token,()=>{b(),o.policySpec=n.token?.name??""}),S(()=>T.value?.publicKey,a=>{a||(b(),n.address="")}),S(()=>n.address,async()=>{n.valid=C(n.address)});const _=l(()=>{const a=n.token?.mint??"";return C(a)?new v(a):""}),g=l(()=>C(n.address)?new v(n.address):""),h=K(),d=K(!1);S([_,g,()=>n.valid],async()=>{if(n.token?.mint===O)return d.value=!0;if(_.value&&g.value&&n.valid)try{return h.value=await V(_.value,g.value),await _e(t.connection,h.value),d.value=!0}catch{d.value=!1}d.value=!1}),S([()=>n.valid,()=>n.value,h],()=>{n.valid&&Number(n.value)>0?F():n.fee=x});const m=l(()=>new Je(new D(t.connection,T.value??{publicKey:v.default},D.defaultOptions())));async function F(){const a=await ye(T.value?.publicKey,n.address,Number(n.value),t.connection),w=await ke(a,t.connection)+H;return n.fee=d.value?w:w+be}async function I(){try{if(n.loading=!0,console.log("[debug] on transfer certificate === ",p.value),q.value){let a;n.token?.mint===O?a=await N():a=await Z(),k({type:"positive",message:"Transaction confirmed",actions:[{label:"Explore",color:"white",target:"_blank",href:`https://explorer.solana.com/tx/${a}?cluster=${t.cluster}`,onClick:()=>!1}]}),b(),await f()}else ge()}catch(a){console.error("verifyTransfer error: ",a)}finally{n.loading=!1}}async function N(){if(p.value){const a=new L(Number(n.value)*Te),w=new v(n.address);return await m.value.transfer({amount:a,receiver:w,proofRequest:p.value.pubkey,policy:new v(R.value)})}}async function Z(){if(!E.value||!n.token?.mint)return;const a=u.tokens.find(se=>se.mint===n.token?.mint);if(!a||!_.value||!g.value||!T.value||!p.value)return;const w=await V(_.value,E.value),te=new L(Number(n.value)*10**a.decimals);return await m.value.transferToken({destination:h.value,source:w,tokenMint:_.value,amount:te,receiver:g.value,proofRequest:p.value.pubkey,policy:new v(R.value)})}function ee(a){n.value=a}function ne(a){n.token=a}return{state:n,setMax:ee,setToken:ne,verifyTransfer:I}}),Ye={class:"swap-form"},Ze={class:"swap-field"},en={class:"swap-field__info"},nn={class:"row"},tn=r("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),sn={class:"col row justify-end swap-field__balance q-pr-sm"},an={key:0,class:"insufficient-error"},on=r("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),rn={class:"row justify-between",style:{gap:"10px"}},cn={class:"transfer-address"},ln=r("div",{class:"col transfer-address__label"}," Address ",-1),un={class:"swap-info q-mt-md"},dn=r("dt",null,"Transfer fee:",-1),fn={class:"swap-submit"},pn=he({__name:"TransferCard",setup(t){const{state:e,setMax:s,setToken:o,verifyTransfer:u}=He(),{state:f,tokenBalance:p}=P(),{handleSearchToken:R,handleFilterToken:q,tokens:x}=we();q(Se);const T=l(()=>[...x.value].sort((d,m)=>p(m.symbol)-p(d.symbol))),{connected:E}=J(),k=l(()=>e.token?.mint?p(e.token.mint):0),n=l(()=>k.value===0),b=l(()=>Number(e.value)>k.value);async function _(){const d=b.value?"Insufficient funds":"Not valid address";if(!e.valid||b.value)return Ee.create({type:"negative",timeout:2e3,message:d});u()}function g(){s(k.value),e.token?.mint===SOL_MINT&&(e.value=k.value-Me-3*Ce-H)}const h=l(()=>Number(e.value)>0&&C(e.address));return(d,m)=>{const F=le,I=ce;return W(),Ae(xe,{class:"swap-card transfer-card"},{default:A(()=>[c(j,{class:"swap-card__header"},{default:A(()=>[M(" Transfer ")]),_:1}),c(j,{class:"swap-card__body"},{default:A(()=>[r("div",Ye,[r("div",Ze,[r("div",en,[r("div",nn,[tn,r("div",sn,[i(b)?(W(),Y("div",an," Insufficient funds ")):Ne("",!0),M(" Balance: "+$(i(U)(i(k))),1)]),on])]),r("div",rn,[c(X,{modelValue:i(e).value,"onUpdate:modelValue":m[0]||(m[0]=N=>i(e).value=N),disable:i(n),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:i(re)},{append:A(()=>[c(Q,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:g},{default:A(()=>[M(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),c(F,{disable:!i(E),options:i(T),onHandleSearchToken:i(R),onSetToken:i(o)},null,8,["disable","options","onHandleSearchToken","onSetToken"])])])]),r("div",cn,[ln,c(X,{modelValue:i(e).address,"onUpdate:modelValue":m[1]||(m[1]=N=>i(e).address=N),disable:i(n),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),r("div",un,[r("dl",null,[dn,r("dd",null,$(i(U)(i(e).fee,6)),1)])]),c(I,{class:"q-my-md q-mx-auto"}),r("div",fn,[c(Q,{loading:i(e)?.loading,disable:!i(h),rounded:"",ripple:!1,onClick:_},{default:A(()=>[M(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),c(Re,{showing:i(f)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),mn={},vn={class:"main-block row justify-center"};function _n(t,e){const s=ae,o=pn,u=oe,f=ie;return W(),Y(Fe,null,[c(s,{class:"q-mt-lg"}),r("div",vn,[c(o)]),c(u,{class:"q-mt-lg"}),c(f,{class:"q-mt-lg"})],64)}const hn=qe(mn,[["render",_n]]);export{hn as default};
