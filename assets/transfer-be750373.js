import{_ as ye,a as we,b as he}from"./AppDescriptionTop-c86721ff.js";import{o as Te,_ as Se}from"./PolicyCard.vue_vue_type_script_setup_true_lang-616c146b.js";import{_ as Ae}from"./SelectToken.vue_vue_type_script_setup_true_lang-6bd6a5b2.js";import{P as u,s as ie,u as D,k as Ee,m as l,n as L,q as K,a as re,S as G,t as Q,v as b,w as $,x as Ne,y as Ie,z as xe,A as p,B as U,C as Ce,F as ce,G as Re,H as Fe,I as Me,J as E,K as P,L as H,M as V,N as J,O as Pe,Q as Z,R as We,U as qe,V as le,W as Oe,X as ze,Y as Be,Z as Y,$ as Le,a0 as Ke,a1 as De,a2 as Ue,o as j,a3 as Ve,a4 as N,a5 as je,j as f,a6 as M,a7 as ee,a8 as c,a9 as r,i as ue,aa as Xe,ab as ne,ac as te,ad as se,ae,af as Ge,ag as Qe,ah as $e,ai as He,_ as Je,aj as Ze}from"./index-90b379f1.js";const R=new u("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");new u("TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb");const de=new u("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");new u("So11111111111111111111111111111111111111112");new u("9pan9bMn5HatX4EJdBwg9VgCa7Uz5HL8N1m5D3NdXejP");class q extends Error{constructor(e){super(e)}}class fe extends q{constructor(){super(...arguments),this.name="TokenAccountNotFoundError"}}class Ye extends q{constructor(){super(...arguments),this.name="TokenInvalidAccountError"}}class pe extends q{constructor(){super(...arguments),this.name="TokenInvalidAccountOwnerError"}}class oe extends q{constructor(){super(...arguments),this.name="TokenInvalidAccountSizeError"}}var X;(function(n){n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account"})(X||(X={}));const en=1,nn=ie([D("m"),D("n"),Ee("isInitialized"),l("signer1"),l("signer2"),l("signer3"),l("signer4"),l("signer5"),l("signer6"),l("signer7"),l("signer8"),l("signer9"),l("signer10"),l("signer11")]),tn=nn.span;var W;(function(n){n[n.Uninitialized=0]="Uninitialized",n[n.Initialized=1]="Initialized",n[n.Frozen=2]="Frozen"})(W||(W={}));const me=ie([l("mint"),l("owner"),L("amount"),K("delegateOption"),l("delegate"),D("state"),K("isNativeOption"),L("isNative"),L("delegatedAmount"),K("closeAuthorityOption"),l("closeAuthority")]),C=me.span;async function sn(n,e,t,a=R){const i=await n.getAccountInfo(e,t);return an(e,i,a)}function an(n,e,t=R){if(!e)throw new fe;if(!e.owner.equals(t))throw new pe;if(e.data.length<C)throw new oe;const a=me.decode(e.data.slice(0,C));let i=re.Buffer.alloc(0);if(e.data.length>C){if(e.data.length===tn)throw new oe;if(e.data[C]!=X.Account)throw new Ye;i=e.data.slice(C+en)}return{address:n,mint:a.mint,owner:a.owner,amount:a.amount,delegate:a.delegateOption?a.delegate:null,delegatedAmount:a.delegatedAmount,isInitialized:a.state!==W.Uninitialized,isFrozen:a.state===W.Frozen,isNative:!!a.isNativeOption,rentExemptReserve:a.isNativeOption?a.isNative:null,closeAuthority:a.closeAuthorityOption?a.closeAuthority:null,tlvData:i}}function on(n,e,t,a,i=R,d=de){return rn(n,e,t,a,re.Buffer.alloc(0),i,d)}function rn(n,e,t,a,i,d=R,m=de){const h=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:G.programId,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1}];return new Q({keys:h,programId:m,data:i})}var cn=Object.defineProperty,ln=(n,e,t)=>e in n?cn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,un=(n,e,t)=>(ln(n,typeof e!="symbol"?e+"":e,t),t);const dn=new b.BeetArgsStruct([["instructionDiscriminator",b.uniformFixedSizeArray(b.u8,8)],["amount",b.u64]],"SplTransferInstructionArgs"),fn=[67,186,237,99,235,243,166,198];function pn(n,e,t=new u("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[a]=dn.serialize({instructionDiscriminator:fn,...e}),i=[{pubkey:n.sender,isWritable:!0,isSigner:!0},{pubkey:n.receiver,isWritable:!0,isSigner:!1},{pubkey:n.tokenMint,isWritable:!1,isSigner:!1},{pubkey:n.source,isWritable:!0,isSigner:!1},{pubkey:n.destination,isWritable:!0,isSigner:!1},{pubkey:n.policy,isWritable:!1,isSigner:!1},{pubkey:n.proofRequest,isWritable:!1,isSigner:!1},{pubkey:n.tokenProgram??R,isWritable:!1,isSigner:!1},{pubkey:n.systemProgram??G.programId,isWritable:!1,isSigner:!1}];if(n.anchorRemainingAccounts!=null)for(const d of n.anchorRemainingAccounts)i.push(d);return new Q({programId:t,keys:i,data:a})}const mn=new b.BeetArgsStruct([["instructionDiscriminator",b.uniformFixedSizeArray(b.u8,8)],["amount",b.u64]],"TransferInstructionArgs"),vn=[163,52,200,231,140,3,69,186];function gn(n,e,t=new u("ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe")){const[a]=mn.serialize({instructionDiscriminator:vn,...e}),i=[{pubkey:n.sender,isWritable:!0,isSigner:!0},{pubkey:n.receiver,isWritable:!0,isSigner:!1},{pubkey:n.policy,isWritable:!1,isSigner:!1},{pubkey:n.proofRequest,isWritable:!1,isSigner:!1},{pubkey:n.systemProgram??G.programId,isWritable:!1,isSigner:!1}];if(n.anchorRemainingAccounts!=null)for(const d of n.anchorRemainingAccounts)i.push(d);return new Q({programId:t,keys:i,data:a})}const _n="ATRh9CiamTjKiJ3XcsbxmGtDoeqg6XujUvgPLemEMCBe",kn=new u(_n);class bn{constructor(e){un(this,"programId",kn),this.provider=e}get connection(){return this.provider.connection}async transfer(e,t){const a=this.createTransferTx(e);return this.provider.sendAndConfirm(a,[],t)}createTransferTx(e){const t=gn({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver},{amount:e.amount});return new $().add(t)}async getTransferFee(e){const t=this.createTransferTx(e);return this.transactionFee(t)}async transferToken(e,t){const a=await this.createTransferTokenTx(e);return this.provider.sendAndConfirm(a,[],t)}async createTransferTokenTx(e){const t=new $;try{await sn(this.connection,e.destination)}catch(a){(a instanceof fe||a instanceof pe)&&t.add(on(this.provider.publicKey,e.destination,e.receiver,e.tokenMint))}return t.add(pn({proofRequest:e.proofRequest,policy:e.policy,sender:this.provider.publicKey,receiver:e.receiver,source:e.source,destination:e.destination,tokenMint:e.tokenMint},{amount:e.amount})),t}async getTransferTokenFee(e){const t=await this.createTransferTokenTx(e);return this.transactionFee(t)}async transactionFee(e){e.recentBlockhash=(await this.connection.getLatestBlockhash("finalized")).blockhash,e.feePayer=this.provider.publicKey;const{value:t}=await this.connection.getFeeForMessage(e.compileMessage(),"confirmed");return Number(t)}}const yn=Ne("transfer",()=>{const n=Ie(),e=xe(),t=p(()=>e.tokens),a=U(),{state:i,getUserTokens:d}=U(),m=p(()=>a.certificate),h=p(()=>a.requiredPolicy),O=p(()=>a.certificateValid),I=0,T=Ce(),{publicKey:F}=ce();Re();const v=Fe("token-transfer",""),s=Me({address:"",value:void 0,loading:!1,token:void 0,fee:I,valid:!1});E(t,()=>{t.value.length&&(console.log("find token ===================== ",t.value.find(o=>o.mint===v.value)),s.token=t.value.find(o=>o.mint===v.value)??t.value[0])},{immediate:!0});function y(){s.value=void 0,s.fee=I}E(()=>s.token,()=>{y(),a.policySpec=s.token?.name??"",console.log("state token ===================== ",s.token),s.token&&(v.value=s.token.mint,console.log("transfer token ===================== ",v.value))}),E(()=>T.value?.publicKey,o=>{o||(y(),s.address="")}),E(()=>s.address,async()=>{s.valid=P(s.address)});const k=p(()=>{const o=s.token?.mint??"";return P(o)?new u(o):""}),w=p(()=>P(s.address)?new u(s.address):""),S=H(),g=H(!1);E([k,w,()=>s.valid],async()=>{if(s.token?.mint===V)return g.value=!0;if(k.value&&w.value&&s.valid)try{return S.value=await J(k.value,w.value),await Pe(n.connection,S.value),g.value=!0}catch{g.value=!1}g.value=!1}),E([()=>s.valid,()=>s.value,S],()=>{s.valid&&Number(s.value)>0?z():s.fee=I});const _=p(()=>new bn(new Z(n.connection,T.value??{publicKey:u.default},Z.defaultOptions())));async function z(){const o=await We(T.value?.publicKey,s.address,Number(s.value),n.connection),A=await qe(o,n.connection)+le;return s.fee=g.value?A:A+Oe}async function B(){try{if(s.loading=!0,console.log("[debug] on transfer certificate === ",m.value),O.value){let o;s.token?.mint===V?o=await x():o=await ve(),ze(`https://explorer.solana.com/tx/${o}?cluster=${n.cluster}`),y(),await d()}else Be()}catch(o){console.error("verifyTransfer error: ",o)}finally{s.loading=!1}}async function x(){if(m.value){const o=new Y(Number(s.value)*Le),A=new u(s.address);return await _.value.transfer({amount:o,receiver:A,proofRequest:m.value.pubkey,policy:new u(h.value)})}}async function ve(){if(!F.value||!s.token?.mint)return;const o=i.tokens.find(be=>be.mint===s.token?.mint);if(!o||!k.value||!w.value||!T.value||!m.value)return;const A=await J(k.value,F.value),ke=new Y(Number(s.value)*10**o.decimals);return await _.value.transferToken({destination:S.value,source:A,tokenMint:k.value,amount:ke,receiver:w.value,proofRequest:m.value.pubkey,policy:new u(h.value)})}function ge(o){s.value=o}function _e(o){console.log("set token ======== ",o),s.token=o}return{state:s,setMax:ge,setToken:_e,verifyTransfer:B}}),wn={class:"swap-form"},hn={class:"swap-field"},Tn={class:"swap-field__info"},Sn={class:"row"},An=c("div",{class:"col-2 swap-field__label"}," AMOUNT ",-1),En={class:"col row justify-end swap-field__balance q-pr-sm"},Nn={key:0,class:"insufficient-error"},In=c("div",{class:"token-select swap-field__label q-pl-sm"}," ASSET ",-1),xn={class:"row justify-between",style:{gap:"10px"}},Cn={class:"transfer-address"},Rn=c("div",{class:"col transfer-address__label"}," Address ",-1),Fn={class:"swap-info q-mt-md"},Mn=c("dt",null,"Transfer fee:",-1),Pn={class:"swap-submit"},Wn=Ke({__name:"TransferCard",setup(n){const{state:e,setMax:t,setToken:a,verifyTransfer:i}=yn(),{state:d,tokenBalance:m}=U(),{handleSearchToken:h,handleFilterToken:O,tokens:I}=De();O(Ue);const T=p(()=>[...I.value].sort((g,_)=>m(_.symbol)-m(g.symbol))),{connected:F}=ce(),v=p(()=>e.token?.mint?m(e.token.mint):0),s=p(()=>v.value===0),y=p(()=>Number(e.value)>v.value);async function k(){const g=y.value?"Insufficient funds":"Not valid address";if(!e.valid||y.value)return Qe.create({type:"negative",timeout:2e3,message:g});i()}function w(){t(v.value),e.token?.mint===V&&(e.value=v.value-$e-3*He-le)}const S=p(()=>F.value&&Number(e.value)>0&&P(e.address));return(g,_)=>{const z=Ae,B=Se;return j(),Ve(je,{class:"swap-card transfer-card"},{default:N(()=>[f(ee,{class:"swap-card__header"},{default:N(()=>[M(" Transfer ")]),_:1}),f(ee,{class:"swap-card__body"},{default:N(()=>[c("div",wn,[c("div",hn,[c("div",Tn,[c("div",Sn,[An,c("div",En,[r(y)?(j(),ue("div",Nn," Insufficient funds ")):Xe("",!0),M(" Balance: "+ne(r(te)(r(v))),1)]),In])]),c("div",xn,[f(se,{modelValue:r(e).value,"onUpdate:modelValue":_[0]||(_[0]=x=>r(e).value=x),disable:r(s),maxlength:14,outlined:"",placeholder:"0.0",class:"swap-input col",onKeypress:r(Te)},{append:N(()=>[f(ae,{dense:"",unelevated:"",ripple:!1,class:"swap-input__max",onClick:w},{default:N(()=>[M(" MAX ")]),_:1})]),_:1},8,["modelValue","disable","onKeypress"]),f(z,{token:r(e).token,options:r(T),onHandleSearchToken:r(h),onSetToken:r(a)},null,8,["token","options","onHandleSearchToken","onSetToken"])])])]),c("div",Cn,[Rn,f(se,{modelValue:r(e).address,"onUpdate:modelValue":_[1]||(_[1]=x=>r(e).address=x),disable:r(s),maxlength:50,outlined:"",class:"swap-input col"},null,8,["modelValue","disable"])]),c("div",Fn,[c("dl",null,[Mn,c("dd",null,ne(r(te)(r(e).fee,6)),1)])]),f(B,{class:"q-my-md q-mx-auto"}),c("div",Pn,[f(ae,{loading:r(e)?.loading,disable:!r(S),rounded:"",ripple:!1,onClick:k},{default:N(()=>[M(" Send ")]),_:1},8,["loading","disable"])])]),_:1}),f(Ge,{showing:r(d)?.loading,class:"swap-loading",color:"grey"},null,8,["showing"])]),_:1})}}}),qn={},On={class:"main-block row justify-center"};function zn(n,e){const t=ye,a=Wn,i=we,d=he;return j(),ue(Ze,null,[f(t,{class:"q-mt-lg"}),c("div",On,[f(a)]),f(i,{class:"q-mt-lg"}),f(d,{class:"q-mt-lg"})],64)}const Un=Je(qn,[["render",zn]]);export{Un as default};
